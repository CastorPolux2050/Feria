<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feria ARIAS - Sistema de Ventas</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Estilos adicionales para loading */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); }
            50% { transform: none; }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Plus, ShoppingCart, CreditCard, DollarSign, Check, X, Trash2, RefreshCw } = lucide;

        const SistemaVentas = () => {
            const [productos, setProductos] = useState([]);
            const [codigoInput, setCodigoInput] = useState('');
            const [carrito, setCarrito] = useState([]);
            const [total, setTotal] = useState(0);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [metodoPago, setMetodoPago] = useState('');
            const [loading, setLoading] = useState(true);
            const [mensaje, setMensaje] = useState('');
            const [procesando, setProcesando] = useState(false);
            
            // URL de tu Google Apps Script
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzioEqAGZppD1p77H1npW8ZEB4nseRBIFGEY1L1nLV6V6eGCwlJFBfLwFWRjQomM6jF/exec';

            useEffect(() => {
                cargarProductos();
            }, []);

            useEffect(() => {
                const nuevoTotal = carrito.reduce((sum, item) => sum + item.precio, 0);
                setTotal(nuevoTotal);
            }, [carrito]);

            const cargarProductos = async () => {
                try {
                    setLoading(true);
                    setMensaje('Conectando con Google Sheets...');
                    
                    console.log('üì° Cargando productos...');
                    
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('üìä Resultado:', result);
                    
                    if (result.success) {
                        setProductos(result.productos);
                        setLoading(false);
                        setMensaje(`‚úÖ ${result.productos.length} productos cargados`);
                        setTimeout(() => setMensaje(''), 3000);
                    } else {
                        throw new Error(result.message || 'Error del servidor');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error cargando productos:', error);
                    setLoading(false);
                    setMensaje(`‚ùå Error: ${error.message}`);
                    setTimeout(() => setMensaje(''), 5000);
                }
            };

            const buscarProducto = (codigo) => {
                return productos.find(p => p.codigo === codigo.toUpperCase().trim());
            };

            const agregarProducto = () => {
                const codigoLimpio = codigoInput.trim().toUpperCase();
                
                if (!codigoLimpio) {
                    setMensaje('‚ö†Ô∏è Ingresa un c√≥digo');
                    setTimeout(() => setMensaje(''), 3000);
                    return;
                }

                const yaEnCarrito = carrito.find(item => item.codigo === codigoLimpio);
                if (yaEnCarrito) {
                    setMensaje('‚ö†Ô∏è Producto ya est√° en el carrito');
                    setTimeout(() => setMensaje(''), 3000);
                    return;
                }

                const producto = buscarProducto(codigoLimpio);
                
                if (producto) {
                    setCarrito([...carrito, { ...producto, id: Date.now() }]);
                    setCodigoInput('');
                    setMensaje(`‚úÖ ${producto.nombre} agregado`);
                    setTimeout(() => setMensaje(''), 2000);
                } else {
                    setMensaje(`‚ùå C√≥digo "${codigoLimpio}" no encontrado`);
                    setTimeout(() => setMensaje(''), 3000);
                }
            };

            const eliminarDelCarrito = (id) => {
                setCarrito(carrito.filter(item => item.id !== id));
            };

            const seleccionarMetodoPago = (metodo) => {
                if (carrito.length === 0) {
                    setMensaje('‚ö†Ô∏è El carrito est√° vac√≠o');
                    setTimeout(() => setMensaje(''), 3000);
                    return;
                }
                setMetodoPago(metodo);
                setShowConfirmModal(true);
            };

            const confirmarVenta = async () => {
                if (procesando) return;
                
                try {
                    setProcesando(true);
                    setMensaje('üí≥ Procesando venta...');
                    
                    const ahora = new Date();
                    const fechaHora = ahora.toLocaleDateString('es-AR') + ' ' + 
                                    ahora.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit'});

                    const datosVenta = {
                        productos: carrito.map(item => ({
                            codigo: item.codigo,
                            fechaHora: fechaHora,
                            medio: metodoPago
                        })),
                        total: total
                    };

                    console.log('üì§ Enviando venta:', datosVenta);

                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify(datosVenta)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('üì® Respuesta:', result);
                    
                    if (result.success) {
                        setMensaje(`üéâ Venta confirmada! $${total.toLocaleString()} (${metodoPago})`);
                        setCarrito([]);
                        setTotal(0);
                        setShowConfirmModal(false);
                        setMetodoPago('');
                        
                        setTimeout(() => cargarProductos(), 2000);
                    } else {
                        throw new Error(result.message || 'Error procesando venta');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error confirmando venta:', error);
                    setMensaje(`‚ùå Error: ${error.message}`);
                } finally {
                    setProcesando(false);
                }
            };

            const cancelarVenta = () => {
                setShowConfirmModal(false);
                setMetodoPago('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    agregarProducto();
                }
            };

            if (loading) {
                return React.createElement('div', { 
                    className: "min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center" 
                }, 
                    React.createElement('div', { 
                        className: "bg-white rounded-xl p-8 text-center shadow-2xl" 
                    },
                        React.createElement('div', { className: "text-5xl mb-4 animate-bounce" }, 'üõçÔ∏è'),
                        React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-2" }, 'Feria ARIAS'),
                        React.createElement('p', { className: "text-gray-600" }, 'Cargando productos...'),
                        React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-2 mt-4" },
                            React.createElement('div', { 
                                className: "bg-purple-600 h-2 rounded-full animate-pulse",
                                style: { width: '70%' }
                            })
                        )
                    )
                );
            }

            return React.createElement('div', { 
                className: "min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-3 sm:p-4" 
            },
                React.createElement('div', { className: "max-w-7xl mx-auto" },
                    // Header
                    React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4" },
                        React.createElement('div', { className: "flex justify-between items-center mb-3" },
                            React.createElement('div', {},
                                React.createElement('h1', { className: "text-xl sm:text-3xl font-bold text-gray-800" },
                                    'üõçÔ∏è Feria ARIAS'
                                ),
                                React.createElement('p', { className: "text-sm sm:text-base text-gray-600" }, 
                                    'Sistema de Ventas'
                                )
                            ),
                            React.createElement('button', {
                                onClick: cargarProductos,
                                disabled: loading,
                                className: "bg-purple-100 hover:bg-purple-200 text-purple-700 p-2 rounded-lg transition-colors"
                            },
                                React.createElement(RefreshCw, { 
                                    className: `w-4 h-4 ${loading ? 'animate-spin' : ''}` 
                                })
                            )
                        ),
                        mensaje && React.createElement('div', {
                            className: `px-4 py-3 rounded-lg text-center text-sm sm:text-base ${
                                mensaje.includes('‚ùå') ? 'bg-red-50 border border-red-200 text-red-800' :
                                mensaje.includes('‚ö†Ô∏è') ? 'bg-yellow-50 border border-yellow-200 text-yellow-800' :
                                mensaje.includes('‚úÖ') || mensaje.includes('üéâ') ? 'bg-green-50 border border-green-200 text-green-800' :
                                'bg-blue-50 border border-blue-200 text-blue-800'
                            }`
                        }, mensaje)
                    ),

                    // Grid principal
                    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6" },
                        // Panel de entrada
                        React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-4 sm:p-6" },
                            React.createElement('h2', { className: "text-lg sm:text-xl font-semibold mb-4 flex items-center gap-2" },
                                React.createElement(ShoppingCart, { className: "w-5 h-5" }),
                                'Agregar Productos',
                                productos.length > 0 && React.createElement('span', { 
                                    className: "text-sm bg-purple-100 text-purple-700 px-2 py-1 rounded-full" 
                                }, `${productos.length} disponibles`)
                            ),
                            
                            React.createElement('div', { className: "space-y-3 mb-4" },
                                React.createElement('input', {
                                    type: "text",
                                    value: codigoInput,
                                    onChange: (e) => setCodigoInput(e.target.value.toUpperCase()),
                                    onKeyPress: handleKeyPress,
                                    placeholder: "C√≥digo (ej: CV1, SV1, LV8...)",
                                    className: "w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-mono",
                                    disabled: procesando
                                }),
                                React.createElement('button', {
                                    onClick: agregarProducto,
                                    disabled: procesando || !codigoInput.trim(),
                                    className: "w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 text-lg font-medium shadow-lg"
                                },
                                    React.createElement(Plus, { className: "w-5 h-5" }),
                                    'Agregar Producto'
                                )
                            ),

                            // Carrito
                            React.createElement('div', { className: "space-y-3 max-h-64 overflow-y-auto" },
                                carrito.length === 0 ?
                                    React.createElement('div', { className: "text-gray-500 text-center py-8" },
                                        'üõí Carrito vac√≠o'
                                    ) :
                                    carrito.map((item) =>
                                        React.createElement('div', { 
                                            key: item.id, 
                                            className: "bg-gray-50 p-3 rounded-lg border" 
                                        },
                                            React.createElement('div', { className: "flex justify-between items-start" },
                                                React.createElement('div', { className: "flex-1 min-w-0" },
                                                    React.createElement('div', { className: "font-semibold text-gray-800" },
                                                        `${item.codigo} - ${item.tipo}`
                                                    ),
                                                    React.createElement('div', { className: "text-sm text-gray-600 truncate" },
                                                        item.nombre
                                                    ),
                                                    React.createElement('div', { className: "text-lg font-bold text-green-600 mt-1" },
                                                        `$${item.precio.toLocaleString()}`
                                                    )
                                                ),
                                                React.createElement('button', {
                                                    onClick: () => eliminarDelCarrito(item.id),
                                                    disabled: procesando,
                                                    className: "text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors"
                                                },
                                                    React.createElement(Trash2, { className: "w-4 h-4" })
                                                )
                                            )
                                        )
                                    )
                            )
                        ),

                        // Panel de pago
                        React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-4 sm:p-6" },
                            React.createElement('h2', { className: "text-lg sm:text-xl font-semibold mb-4" }, 
                                'Resumen de Venta'
                            ),
                            
                            React.createElement('div', { className: "bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-200 p-6 rounded-xl mb-6 text-center" },
                                React.createElement('div', { className: "text-3xl sm:text-4xl font-bold text-gray-800" },
                                    `$${total.toLocaleString()}`
                                ),
                                React.createElement('div', { className: "text-gray-600 mt-1" },
                                    `${carrito.length} producto${carrito.length !== 1 ? 's' : ''}`
                                )
                            ),

                            React.createElement('div', { className: "space-y-3" },
                                React.createElement('button', {
                                    onClick: () => seleccionarMetodoPago('Alias'),
                                    disabled: carrito.length === 0 || procesando,
                                    className: "w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-4 px-4 rounded-xl transition-colors flex items-center justify-center gap-3 text-lg font-medium shadow-lg"
                                },
                                    React.createElement(CreditCard, { className: "w-6 h-6" }),
                                    'Pagar con Alias'
                                ),
                                
                                React.createElement('button', {
                                    onClick: () => seleccionarMetodoPago('Efectivo'),
                                    disabled: carrito.length === 0 || procesando,
                                    className: "w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-4 px-4 rounded-xl transition-colors flex items-center justify-center gap-3 text-lg font-medium shadow-lg"
                                },
                                    React.createElement(DollarSign, { className: "w-6 h-6" }),
                                    'Pagar en Efectivo'
                                )
                            )
                        )
                    ),

                    // Modal de confirmaci√≥n
                    showConfirmModal && React.createElement('div', { 
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" 
                    },
                        React.createElement('div', { className: "bg-white rounded-xl p-6 max-w-sm w-full mx-4" },
                            React.createElement('div', { className: "text-center mb-6" },
                                React.createElement('div', { className: "text-5xl mb-4" },
                                    procesando ? '‚è≥' : 'ü§î'
                                ),
                                React.createElement('h3', { className: "text-xl font-semibold mb-2" },
                                    procesando ? 'Procesando...' : '¬øConfirmar venta?'
                                )
                            ),
                            
                            React.createElement('div', { className: "bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-200 p-4 rounded-xl mb-6 text-center" },
                                React.createElement('div', { className: "text-2xl font-bold text-gray-800" },
                                    `$${total.toLocaleString()}`
                                ),
                                React.createElement('div', { className: "text-gray-600 mt-1" },
                                    `${carrito.length} producto${carrito.length !== 1 ? 's' : ''}`
                                ),
                                React.createElement('div', { className: "text-sm font-medium mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full inline-block" },
                                    `üí≥ ${metodoPago}`
                                )
                            ),

                            React.createElement('div', { className: "space-y-3" },
                                React.createElement('button', {
                                    onClick: cancelarVenta,
                                    disabled: procesando,
                                    className: "w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2 font-medium"
                                },
                                    React.createElement(X, { className: "w-5 h-5" }),
                                    procesando ? 'Procesando...' : 'Cancelar'
                                ),
                                React.createElement('button', {
                                    onClick: confirmarVenta,
                                    disabled: procesando,
                                    className: "w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-xl transition-colors flex items-center justify-center gap-2 font-medium shadow-lg"
                                },
                                    procesando ? 
                                        React.createElement(React.Fragment, {},
                                            React.createElement('div', { className: "w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" }),
                                            'Procesando...'
                                        ) :
                                        React.createElement(React.Fragment, {},
                                            React.createElement(Check, { className: "w-5 h-5" }),
                                            'Confirmar Venta'
                                        )
                                )
                            )
                        )
                    )
                )
            );
        };

        // Renderizar la aplicaci√≥n
        ReactDOM.render(React.createElement(SistemaVentas), document.getElementById('root'));
    </script>
</body>
</html>
